---
title: "ETC5521 Assignment 1"
subtitle: "Amusement Park injuries"
team: "bilby"
author:
  - "Yuheng Cui"
  - "Jimmy Effendy"
date: "`r Sys.Date()`"
output: 
  bookdown::html_document2
bibliography: references.bib
biblio-style: authoryear-comp
---

[This assignment is for ETC5521 Assignment 1 by Team `r rmarkdown::metadata$team` comprising of `r knitr::combine_words(rmarkdown::metadata$author)`.]{style="color:#006DAE;"}

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, fig.align = "center")
library(dplyr)
library(visdat)
library(readr)
library(tidyverse)
library(lubridate)
library(knitr)
library(kableExtra)
library(tidytext)
library(wordcloud)
```

```{r rawData, include = FALSE}
tx_injuries <- read_csv("https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2019/2019-09-10/tx_injuries.csv")


safer_parks <- read_csv("https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2019/2019-09-10/saferparks.csv")
```

# Introduction and motivation

intro: ...

motivation: study the injuries record, find out the risky groups. In the future, amusement parks can pay more attention on those groups and entertaining equipments. Consequently, reduce the injuries occur in amusement parks and increase the well beings of society.

# Data description

The datasets are downloaded from [here](https://github.com/rfordatascience/tidytuesday/tree/master/data/2019/2019-09-10) from GitHub. There are two datasets provided in the repository; one originated from [data.world](https://data.world/amillerbernd/texas-amusement-park-accidents) and another from [Safer Parks database](https://ridesdatabase.org/saferparks/data/).

The data.world dataset is about all incidents occurred at amusement parks in Texas in 1st of February 2013 to 1st of February 2017 recorded by Texas Department of Insurance (data.world, 2020). This dataset has `r dim(tx_injuries)[1]` number of observations and `r dim(tx_injuries)[2]` number of variables. Fig \@ref(fig:quality-of-tx) shows the dataset has too many missing values in **other** variable and many missing values in **serial_no** variable. Good news is that these two variables has little effects on our analysis, thus, we can remove these two variables. **Age** should be converted to numeric variable and **injury_date** should be date variable.

```{r quality-of-tx, fig.cap = "Texas amusement parks dataset"}
vis_dat(tx_injuries)
```

The accidents records in the Saferparks dataset, on the other hand, originated from the U.S. state and federal safety agencies regulating amusement rides (Saferparks, 2020). It has `r dim(safer_parks)[1]` observations and `r dim(safer_parks)[2]` variables. Fig \@ref(fig:quality-of-safer) shows 4 variables have too many missing values to be analysed, therefore, we ought to ignore them. **acc_date** should be converted to date variable. Although **manufacturer** has many missing values as well, we decided to keep it because it may be insightful.

```{r clean,eval= FALSE}
tx_injuries %>% 
  select(-other, -serial_no, -injury_report_rec) %>% 
  mutate(age = as.numeric(age),
         injury_date = as.Date(injury_date, format = "%m/%d/%Y")) # convert to date?
```

```{r quality-of-safer, fig.cap = "Saferparks dataset"}
vis_dat(safer_parks)
```

# Analysis and findings

## Primary question: what are the high-risk groups?

The primary question in this report is to find out the high-risk group. Consequently, draw parks attention to pay more attention on these groups for their safety. We mainly analyse the age and gender for the primary quesiton. The Saferparks dataset cannot be used here, because the dataset record injury records instead of individuals; that is, we do not know the ages of each injuried. 

First, we need to clean the data. The missing values in age and gender is removed and the variable type is converted from character to numeric. Second, we unify the records in gender because some observations record gender male as 'M' while others record as 'm'. Third, calculate the percentage of each age group.

```{r tx-pm1, fig.cap = "Line plot for age"}
tx_gender_age <- tx_injuries %>%
  # remove missing values in gender
  filter(!is.na(gender)) %>% 
  # remove missing values in age
  filter(!is.na(age)) %>% 
  mutate(gender = recode(gender,
                         "m" = "M",
                         "f" = "F")) %>% # unify gender record
  mutate(age = as.numeric(age))
  
   

tx_ob <- nrow(tx_gender_age)
  
tx_gender_age %>% 
  count(age, sort = FALSE) %>% 
  mutate(percentage = n*100/tx_ob) %>% 
  ggplot(aes(x = age, y = percentage)) + 
  geom_line() +
  geom_hline(yintercept = 1, color = 'red')

```

Fig \@ref(fig:tx-pm1) illustrates the distribution of injuried ages. Surprisingly, the most injuried were babies. The red line indicate 1 percent. Below this line, we believe the injuried cases were relatively rare.


```{r tx-pm1-tab}
tx_gender_age %>% 
  group_by(age) %>% 
  count() %>% 
  mutate(percent = n*100/tx_ob) %>% 
  arrange(-percent) %>% 
  select(-n) %>% 
  head(10) %>% 
  kable(caption = "Top 10 risky age group in amusement parks in Texas") %>% 
  kable_styling(bootstrap_options = c("striped", "hover"))
```

```{r tx-pm1-gender}
tx_gender_age%>% 
  group_by(gender, age) %>% 
  count(gender,age) %>% 
  ungroup() %>% 
  mutate(percent = round(n*100/tx_ob, 2)) %>% 
  select(-n) %>% 
  arrange(-percent) %>% 
  head(10) %>% 
  kable(caption = "Top 10 risky group by gender in amusement parks in Texas") %>% 
  kable_styling(bootstrap_options = c("striped", "hover"))
```

```{r tx-pm1-pct, include = FALSE}
tx_kid <- tx_gender_age %>% 
  group_by(age) %>% 
  count() %>% 
  mutate(percent = n*100/tx_ob) %>% 
  arrange(-percent) %>% 
  ungroup() %>% 
  filter(age < 18 & age > 0) %>% 
  pull(percent) %>% 
  sum()

tx_kid_fe <- tx_gender_age%>% 
  group_by(gender, age) %>% 
  count(gender,age) %>% 
  ungroup() %>% 
  mutate(percent = round(n*100/tx_ob, 2)) %>% 
  filter(gender == "F" & age < 18 & age >0) %>% 
  pull(percent) %>% 
  sum()

tx_kid_m <- tx_kid - tx_kid_fe
```

Table \@ref(tab:tx-pm1-tab) shows the ranking of injuried ages. Injuried babies occupies nearly 10% of the dataset. In the dataset `r round(tx_kid, 2)` percent injuried are under 18, except babies. We distinguish babies from other age groups because babies are carried by their parents and babies are not able to move to any places by their own. 

If we take gender into account, we can see gender distributions by age. Table \@ref(tab:tx-pm1-gender) shows the top-10 rankings by gender and age. In top-10 list, it seems that more girls get injuried than boys in amusement parks in Texas. However, if we look at the whole dataset, age between  1 and 16, `r round(tx_kid_fe, 2)` percent are girls while `r round(tx_kid_m, 2)` are boys.

In summary, parents really need to pay more attention on their babies in amusement parks. And any children (under 18) need to draw the parks staff's attention. 


## Secondary question1: what is the most dangerous equipment in parks and what is the most body parts injuried?

First secondary question is "what is the most dangerous equipment in parks". We count the total number of injuries by device type. Table \@ref(tab:safer-equip) shows top-10 rankings of high-risk equipment. It is not surprising that roller coaster is the equipment that causes the most injuries. @gutierrez reported that seven cases are related to roller coaster among eight high-profile U.S. amusement park deaths before 2016. 

```{r safer-equip}
safer_parks %>% 
  group_by(device_type) %>% 
  summarise(tot_num_injuries = sum(num_injured)) %>% 
  arrange(-tot_num_injuries) %>% 
  head(10) %>% 
  kable(caption = "Top 10 risky device type") %>% 
  kable_styling(bootstrap_options = c("striped", "hover"))
```

```{r sq1-wordcloud, fig.cap = "Injury description --- word cloud", out.height= '100%', out.width= '100%'}
data(stop_words)
safer_parks %>% 
  select(injury_desc) %>% 
  unnest_tokens(word, injury_desc) %>% 
  anti_join(stop_words) %>% 
  count(word) %>% 
  with(wordcloud(word, n ,max.words = 80))

```

Fig \@ref(fig:sq1-wordcloud) shows the frequent words in injury description. Ignoring the words "injury" and "pain", we can see that head, neck knee, ankle, shoulder frequently appear.

In summary, amusement parks should pay extra attention on roller coaster because unlike other subjects roller coaster's failure can cause severe consequence. First, they should regularly maintain the roller coaster, in order to reduce mechanical failure. Second, train the staff and ask them to check to-do list every time launch the equipments. Third, ask visitors to follow the safety requirements. Furthermore, visitors should also protect their head, neck and shoulder. Those body parts are vulnerable and important and they are always injuried in amusement park injury cases.

# Acknowledgments
The following packages are used to produce this report:
visdat [@visdat], dplyr [@dplyr], readr[@readr], tidyverse [@tidyverse], lubridate [@lubridate], knitr [@knitr], kableExtra [@kableExtra], tidytext [@tidytext], wordcloud [@wordcloud]


# References


