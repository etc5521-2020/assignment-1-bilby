---
title: "ETC5521 Assignment 1"
subtitle: "Amusement Park injuries"
team: "bilby"
author:
  - "(Yuheng Cui)"
  - "(Jimmy Effendy)"
  - "Weihao Li"
  - "Yan Ma"
date: "`r Sys.Date()`"
output:
  bookdown::html_document2:
    citation_package: biblatex
    number_sections: yes
    theme: cerulean
    toc: yes
    toc_float:
      collapsed: yes
csl: apa-6th-edition.csl
bibliography: reference.bib
link-citations: yes
---

[This assignment is for ETC5521 Assignment 1 & 2 by Team `r rmarkdown::metadata$team` comprising of `r knitr::combine_words(rmarkdown::metadata$author)`.]{style="color:#006DAE;"}

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, fig.align = "center")
library(dplyr)
library(visdat)
library(readr)
library(tidyverse)
library(lubridate)
library(knitr)
library(kableExtra)
library(tidytext)
library(wordcloud2)
library(here)
library(janitor)
library(plotly)
library(rlist)
Sys.setlocale("LC_ALL","English")
```

```{r rawData, include = FALSE}
tx_injuries <- read_csv("https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2019/2019-09-10/tx_injuries.csv")


safer_parks <- read_csv("https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2019/2019-09-10/saferparks.csv")

tx_policies <- read.csv(here::here("data/tx_policies.csv"))
```

# Introduction and Motivation

Families and friends tend to spend their holidays and weekends in amusement parks. The popularity of amusement park has been growing in popularity in recent years, with worldwide attendance at the top 10 amusement park groups reached half a billion mark for the first time last year [@schneider_2019], with 4% year-on-year growth [@tea2019].

With this ever increasing popularity, it is therefore reasonable to consider that the safety of amusement rides is subject to substantial public interests [@woodcock2014amusement]. It was estimated that the annual number of ride-related injuries in North America was 1,289 in 2018; which was 26% higher compared to 2017 [@iaapa2018]. International Association of Amusement Parks and Attractions further stated that approximately 11% of those injuries are "serious", meaning that they result in urgent admission and hospitalization for more than 24 hours for non-medical observation reasons, or causes fatality.

While accidents that occur in amusement parks are arguably not frequent, they generate prominent effects when they happen. International Association of Amusement Parks and Attractions [-@iaapa2017] reported that following a ride malfunction in Australia killing four people, the park and also other venues in Australia suffered considerable declines in attendance. This shows that public confidence, safety, and commercial feasibility are strongly interconnected [@woodcock2014amusement].

Thorough evaluations to injury records related to amusement rides are aligned with public interests and are integral to encourage constant improvement in the industry. This paper aims to find factors that have major influence to amusement ride accidents. Uncovering this insight may encourage amusement park owners to utilize their resources more wisely in favor of those groups or equipment that are at the most risk. In addition, this report may also facilitate regulatory bodies when safety standards and regulations are developed.

We believe amusement park must make the effort to reduce the incidents; the effort refers to maintaining equipment, training staff and monitoring visitors. At same time, visitors should also follow the parks regulations and equipment instructions. After all, visitors should be responsible for their own safeties in the first place. Reduce the injuries occur in amusement parks and increase the well beings of society. 

Firstly, description of data used in the report and how it is prepared for analysis will be discussed. Then, analysis and findings acquired from the dataset will be presented and discussed. In the end, there will be a conclusion on major findings and discussion on future studies.

# Data Description

The datasets are downloaded from the Github repository of [Tidy Tuesday](https://github.com/rfordatascience/tidytuesday/tree/master/data/2019/2019-09-10). @Tidy-Tuesday is a weekly social data project in R. We are using datasets adopted by its activity on September 10, 2019.

There are two datasets provided in the repository; one originated from [data.world](https://data.world/amillerbernd/texas-amusement-park-accidents) and another from [Saferparks database](https://ridesdatabase.org/saferparks/data/). An additional data from Texas Department of Insurance (TDI) about current available insurance policies is used for this report [@tdi_pol].

## Injury records in Texas amusement parks  (`tx_injuries.csv`)

The Texas amusement parks injury dataset originated from data.world is collected by Texas Department of Insurance (TDI) [@dataworld]. It is a record of any injuries caused by an amusement ride from February the 1st 2013 to February the 1st 2017 occurring in the State of Texas [@dataworld]. An amusement ride is "any mechanical, gravity, or water device or devices that carry or convey passengers along, around, or over a fixed or restricted route or course or within a defined area for the purpose of giving its passengers amusement, pleasure, or excitement" [@tdi]. According to TDI [-@tdi], a quarterly injury report needed to be submitted by amusement ride owners and operators. TDI further stated that this record relates to any injuries that require medical treatment or result in death. 

This dataset has `r nrow(tx_injuries)` number of observations and `r ncol(tx_injuries)` number of variables. The name, type and description of each variable in `tx_injuries.csv` can be found in the data dictionary below.

|variable          |class     |description |
|:-----------------|:---------|:-----------|
|injury_report_rec |double    | Unique Record ID |
|name_of_operation |character | Company name |
|city              |character | City |
|st                |character | State (all TX) |
|injury_date       |character | Injury date - note there are some different formats |
|ride_name         |character | Ride Name |
|serial_no         |character | Serial number of ride |
|gender            |character | Gender of the injured individual |
|age               |character | Age of the injured individual |
|body_part         |character | Body part injured |
|alleged_injury    |character | Alleged injury - type of injury |
|cause_of_injury   |character | Approximate cause of the injury (free text) |
|other             |character | Anecdotal information in addition to cause of injury |

From the data quality check in Fig \@ref(fig:quality-of-tx), we find the dataset has high percentage of missing values in variable `other` and `serial_no`. However, it has minor effect on our analysis. Thus, they can be removed from the dataset. Besides, there are potential issues with the data types of variable `age` and `injury_date`, which can be solved by converting them into `integer` and `date` respectively.

```{r quality-of-tx, fig.cap = 'A visualization of data quality check on Injury records in Texas amusement parks. The data plot is an "at-a-glance" plot generated using the `visdat` package. The y axis represent each observation, and the x axis represent each variable. In this dataset, most of the variables are provided in "character" with few missing values. Serious data quality issues can be observed in variable `serial_no` and `other`, but they are irrelevant to this analysis.'}

vis_dat(tx_injuries)
```

## Accidents records (`safer_parks.csv`)

The accidents records in the Saferparks dataset, on the other hand, originated from the U.S. State and Federal safety agencies regulating amusement rides [@saferpark_web]. Saferparks achieved this by submitting public records requests to those agencies (both federal and states agencies). In some cases, additional requests were submitted to specific agencies to achieve particular goals [@saferpark_web]. As a result, Saferparks needs to harmonize these datasets into their database.  

It has `r nrow(safer_parks)` observations and `r ncol(safer_parks)` variables. The name, type and description of each variable in `safer_parks.csv` can be found in the data dictionary below.

|variable             |class     |description |
|:--------------------|:---------|:-----------|
|acc_id               |double    | Unique ID |
|acc_date             |character | Accident Date |
|acc_state            |character | Accident State |
|acc_city             |character | Accident City |
|fix_port             |character |.           |
|source               |character | Source of injury report |
|bus_type             |character | Business type |
|industry_sector      |character | Industry sector |
|device_category      |character | Device category |
|device_type          |character | Device type |
|tradename_or_generic |character | Common name of the device |
|manufacturer         |character | Manufacturer of device |
|num_injured          |double    | Num injured |
|age_youngest         |double    | Youngest individual injured |
|gender               |character | Gender of individual injured |
|acc_desc             |character | Description of accident |
|injury_desc          |character | Injury description |
|report               |character | Report URL |
|category             |character | Category of accident |
|mechanical           |double    | Mechanical failure (binary NA/1) |
|op_error             |double    | Operator error (binary NA/1)|
|employee             |double    | Employee error (binary NA/1)|
|notes                |character | Additional notes| 


The data quality check in Fig \@ref(fig:quality-of-safer) shows 4 variables have too many missing values to be analysed, therefore, we ought to ignore them. `acc_date` should be converted to date variable. Although `manufacturer` has many missing values as well, we decided to keep it because it may be insightful.

```{r quality-of-safer, fig.cap = 'A data quality check on the Saferparks accidents dataset. The y axis represent each observation, and the x axis represent each variable. The data plot is an "at-a-glance" plot. This dataset has serious missing value issues in variable `manufacturer`, `report`, `notes`, `mechanical`, `op_error` and `employee`.'}

vis_dat(safer_parks)
```

## Insurance policies (`tx_policies.csv`)

The insurance policies dataset originated from Texas Department of Insurance. This dataset lists the amusement ride current insurance policies in Texas. It has `r nrow(tx_policies)` observations and `r ncol(tx_policies)` variables. The name, type and description of each variable in `tx_policies.csv` can be found in the data dictionary below.

|variable             |class     |description |
|:--------------------|:---------|:-----------|
|Record               |integer   | Unique ID  |
|Name of Operation    |Character | Name of operation|
|Expiration Date      |Character | The expiration date of the insurance policy|
|Agent                |Character | The name of the sales agent|
|Carrier              |Character | The name of the carrier|

This dataset has very few missing values. Around `r format(mean(complete.cases(tx_policies))*100, digits = 3)`% cases are completed.


## Data Limitation

As documentations related to accident reports provided by TDI are limited, it is difficult to determine the limitation related to the dataset. In addition to a considerable amount of missing values in some of the variables, data dictionary is not provided by TDI. As a result, a fair amount of guesstimates were required for some of the variables provided. Lastly, there is some inconsistency of format in `injury_date` variable.

According to Saferparks [-@saferpark], reporting criteria and its level of details, types of equipment included, and years covered vary widely across year, industry sector, jurisdictions, and other factors. Saferparks further stated that States that are transparent, vigilantly monitor safety incidents, and implement data management systems that are efficient will log higher number of accidents. In other words, having high number of injuries may be an indications of being more attentive to safety, not less [@saferpark]. 

While the dataset can be used to uncover insights of how patrons got hurt in amusement rides, Saferparks do not recommend the dataset to be used for comparison across states, parks, rides or years [@saferpark]. One of the reasons for this is that State laws in relation to amusement ride related injury reporting vary widely. For instance, it is mandatory to report go-kart accidents in Florida but not in California.

Due to these limitations, the report will not use the Saferparks dataset to analyze nation-wide patterns. Hence, this report will largely focus on amusement park accidents that occur in Texas, United States of America.


## Data Cleaning and Transformation

A considerable amount of data wangling needed to be done to the TDI injury datasets prior to the analysis. Firstly, there were inconsistencies of format in the date variable where some of the observations were stored in a serial number format that only Excel recognizes (e.g. 39448). Dates with this format needed to be converted to "YYYY-MM-DD" format.

Secondly, the following variables were added to the TDI injury dataset:

* `injury_year`: the year when the observed injury occurred
* `injury_month`: the month when the observed injury occurred
* `injury_day`: the day when the observed injury occurred
* `season`: the season (U.S.) when the observed injury occurred

TDI dataset about current insurance policies were also needed to be cleaned. Firstly, the `janitor` [@janitor] package was used to make the column names tidy. Next, the agent variable were needed to be wrangled as there were many observations that were misspelled.



Finally, the TDI injury dataset were combined with TDI insurance policies dataset.

Much of the data wrangling and transformation process were done by utilizing the `dplyr` [@dplyr] and `lubridate` [@lubridate] packages.

```{r clean}
#cleaning the injury_date variable
#there were some inconsistency in the format
tx_injuries <- tx_injuries %>% 
  mutate(injury_date = case_when(
    nchar(injury_date) == 5 ~ as.Date(as.numeric(injury_date), origin = "1899-12-30"),
    TRUE ~ mdy(injury_date)
  ))

#adding year, month, day variables to tx_injuries
tx_injuries <- tx_injuries %>% 
  mutate(injury_year = year(injury_date),
         injury_month = month(injury_date, label = TRUE, abbr = TRUE),
         injury_day = day(injury_date)) %>% 
  mutate(season = case_when(
    injury_month == "Jan" ~ "Winter",
    injury_month == "Feb" ~ "Winter",
    injury_month == "Mar" ~ "Spring",
    injury_month == "Apr" ~ "Spring",
    injury_month == "May" ~ "Spring",
    injury_month == "Jun" ~ "Summer",
    injury_month == "Jul" ~ "Summer",
    injury_month == "Aug" ~ "Summer",
    injury_month == "Sep" ~ "Autumn",
    injury_month == "Oct" ~ "Autumn",
    injury_month == "Nov" ~ "Autumn",
    injury_month == "Dec" ~ "Winter",
    TRUE ~ "NA"
  ))

tx_policies <- tx_policies %>%
  janitor::clean_names() %>% 
  mutate(agent = case_when(
    agent == "Ace American Ins Co (Chubb)" ~ "ACE American Insurance Company",
    agent == "Ace American Insurance Company" ~ "ACE American Insurance Company",
    agent == "Hartford Fire Insurance Compan" ~ "Hartford Fire Insurance Company",
    agent == "T.H.E Insurance company" ~ "T.H.E. Insurance Company",
    agent == "Certain Underwriters at Lloyds" ~ "Lloyds",
    TRUE ~ as.character(agent)
  ))
```



```{r tx-complete}
#joining tx_injuries tibble with tx_policies tibble
tx_comp <- tx_injuries %>% 
  left_join(tx_policies,
            by = c("injury_report_rec" = "record")) %>% 
  select(-name_of_operation.y) %>% 
  rename(name_of_operation = name_of_operation.x)
```

# Analysis and findings

## Do age and gender play a major role in amusement park accidents?

The primary question in this report is to discover the patterns in age and gender distribution of amusement park accidents. Consequently, help parks to identify certain high-risk groups and also remind the groups taking care of their own. The Saferparks dataset cannot be used here, because the dataset does not have detail individual records. Instead, we use the injury dataset reported by TDI.

In Figure \@ref(fig:tx-pm1), the overall distribution shape between male and female is not significantly different. There are very few cases around age 20 which could be a potential data quality issue. Unfortunately, this question is out of our scope, and can't be solved using the data on hand.

```{r tx-pm1, fig.cap = "A faceted bar plot for age distribution in amusement park accident records. Missing values are removed. The x axis is the age, the y axis is the percentage. The empirical distribution is multimodal. There are few cases around age 20."}
tx_gender_age <- tx_injuries %>%
  # remove missing values in gender
  filter(!is.na(gender)) %>% 
  mutate(gender = recode(gender,
                         "m" = "M",
                         "f" = "F",
                         "n/a" = "unknown",
                         "N/A" = "unknown")) %>% # unify gender record
  mutate(age = as.numeric(age)) %>% 
    # remove missing values in age
  filter(!is.na(age))
   

tx_ob <- nrow(tx_gender_age)

temp <- tx_gender_age%>%
  filter(gender != "unknown") %>%
  filter(age > 0) %>%
  group_by(gender, age) %>% 
  count(gender,age) %>% 
  ungroup() %>% 
  mutate(percent = round(n*100/tx_ob, 2)) %>% 
  select(-n)

p2 <- temp %>%  
  ggplot() +
  geom_bar(data = select(temp, -gender), aes(x = age, y = percent), stat = "identity", fill = "gray") +
  geom_bar(aes(x = age, y = percent, fill = gender), stat="identity") +
  # geom_text(aes(y=label_ypos, label=percent), vjust=1.6, 
  #           color="white", size=3.5)+
  # scale_fill_brewer(palette="Paired")+
  theme_minimal() +
  xlab("Age") +
  ylab("Percent") +
  facet_wrap(~gender, ncol = 1)

ggplotly(p2)
```


```{r tx-pm1-tab}
temp %>%
  mutate(age_group = cut(age, breaks = seq(0,75,5))) %>%
  group_by(age_group) %>% 
  summarise(percent = sum(percent)) %>%
  arrange(-percent) %>% 
  head(10) %>% 

  kable(caption = "Top 10 most frequent age group in amusement parks accident records in Texas. A high percentage of injured people are teenagers.",
        col.names = c("Age", "Percent")) %>% 
  column_spec(column = 1:2, width = "6cm") %>% 
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)

```

```{r tx-pm1-gender}
temp %>%
  mutate(age_group = cut(age, breaks = seq(0,75,5))) %>%
  group_by(gender, age_group) %>% 
  summarise(percent = sum(percent)) %>%
  arrange(-percent) %>% 
  head(10) %>% 
  kable(caption = "Top 10 most frequent group by gender and age in amusement parks accident records in Texas. Female are at a higher risk of injury.",
        col.names = c("Gender", "Age", "Percent")) %>% 
  column_spec(column = 1:3, width = "4cm") %>% 
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```



```{r tx-pm1-pct, include = FALSE}
tx_kid <- mean(temp$age<=15 & temp$age>5) *100
```

Table \@ref(tab:tx-pm1-tab) shows the ranking of injured ages. Injured babies occupies around 5% of the dataset. In the dataset `r round(tx_kid, 2)`% injured are under 16, except babies. We distinguish babies from other age groups because babies are carried by their parents and babies are not able to move to any places by their own. 

If we take gender into account, like Table \@ref(tab:tx-pm1-gender), which shows the top-10 rankings by gender and age, we will find that more girls get injured than boys in amusement parks in Texas. 

In summary, the age range of the injured is broad (from 0 to 71). But the most injured are young people, especially for children (under 18). And the fact that around 5 percent of the injured are babies indicates that parents must take care of their babies in amusement parks. They should put their babies in first priority.  


## What is the most dangerous equipment in parks?

We count the total number of injuries by device type. Table \@ref(tab:safer-equip) shows top-10 rankings of high-risk equipment. It is not surprising that slide and roller coaster are equipments that cause the most injuries. @gutierrez reported that seven cases are related to roller coaster among eight high-profile U.S. amusement park deaths before 2016. 

```{r safer-equip} 
safer_parks %>% 
  mutate(device_type = ifelse(grepl("slide", device_type, fixed = TRUE), "Slide", device_type)) %>%
  mutate(device_type = ifelse(grepl("Coaster", device_type, fixed = TRUE), "Coaster", device_type)) %>%
  group_by(device_type) %>% 
  summarise(tot_num_injuries = sum(num_injured, na.rm = TRUE)) %>% 
  arrange(-tot_num_injuries) %>% 
  head(10) %>%
  kable(caption = "Top 10 most dangerours devices types.  Slide and coaster are major devices contribute to injuries.",
        col.names = c("Device Type", "Total Number of Injuries")) %>% 
  column_spec(1:2, width = "6cm") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)

```

Amusement parks should pay extra attention on roller coaster because unlike other subjects, roller coaster's failure can cause severe consequence --- no one can escape once a roller coaster is launched. First, they should regularly maintain the roller coaster, in order to reduce mechanical failure. Second, train the staff and ask them to check to-do list every time launch the equipments. Third, ask visitors to follow the safety guide.

## Does amusement ride injuries have seasonal characteristics?

This section will examine whether seasonal trends affected number of amusement ride injuries across the year. Table \@ref(tab:seasonal-trends-table) shows that rides related injuries have seasonal trends and they are consistent across the years. The number of injuries occurred in autumn and winter seasons were relatively low. The number started to rise in spring, and reached its peak in summer.

```{r seasonal-trends-table}
tx_season_table <- tx_injuries %>% 
  filter(season != "NA") %>% 
  group_by(injury_year, season) %>% 
  tally() %>% 
  pivot_wider(names_from = injury_year,
              values_from =n)

tx_season_table %>% 
  kable(caption = "Amusement rides related injuries across years and seasons. A clear seasonal trend can be observed.", 
        col.names = c("Season", "2013", "2014", "2015", "2016", "2017")) %>% 
  column_spec(1, width = "4cm") %>% 
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

Figure \@ref(fig:seasonal-trends-plot) shows how the number of injuries occurred in amusement rides distributed across months and years. It is reflected in the graph that the highest number of injuries that occurred in a single month appeared in June 2015 with 41 injuries. Another interesting feature that appears in the graph is that the numbers of rides related injuries in 2014 and 2017 are relatively low compared to other years.

It may be beneficial for ride owners to focus their resources in spring and summer when number of injuries are at its height. More regular and rigorous inspections to the ride equipment can be performed during these periods. Furthermore, ride owners may also provide staff with additional training in the periods leading up to summer. It may also be advantageous to perform further study to uncover the true drivers of the following questions (which unfortunately are out of scope of this report):

* Why did 2014 and 2017 have comparatively low number of injuries?
* Why did June 2015 have such a high number of injuries?


```{r seasonal-trends-plot, fig.cap="A grouped line chart for ride related injuries to show seasonal trends. The main group is year. The x axis is month and the y axis is total number of injury. In 2015, there are significantly many cases reported in June, which is unusual."}
tx_month <- tx_injuries %>% 
  filter(injury_year != "NA") %>% 
  filter(injury_month != "NA") %>% 
  group_by(injury_year, injury_month) %>% 
  tally()

tx_month$injury_year <- as.factor(tx_month$injury_year)
tx_month$injury_month <- as.factor(tx_month$injury_month)

tx_season_plot <- tx_month %>% 
  ggplot(aes(x = injury_month,
             y = n,
             group = injury_year)) +
  geom_line(aes(color = injury_year)) +
  geom_point(aes(color = injury_year)) +
  labs(colour = "Year") +
  theme_minimal() +
  xlab("Month") +
  ylab("Total Injury")
  

ggplotly(tx_season_plot)
```

## What are the effects of insurance company to number of rides related injuries?

According to TDI [-@tdi_req], every amusement ride in Texas is required to display a compliance sticker. To get these stickers, rides must be insured and inspected [@tdi_req]. TDI, however, are not involved with rides inspections. Instead, it is the ride owner's insurance company that are responsible to perform these inspections. This section will explore whether number of injuries vary across insurance agents responsible in inspecting the quality of rides. A summary table of accidents occurred by insurance agents were constructed by using the combined table of TDI injuries and insurance policies dataset. Table \@ref(tab:accidents-by-insurance) shows that the majority of rides related injuries occurred in amusement parks that were overseen by Hartford Fire Insurance Company. The number is still larger compared to the number of injuries from the rest of the table combined.

```{r accidents-by-insurance}
tx_comp_summary <- tx_comp %>% group_by(agent) %>%
  filter(agent != "NA") %>% 
  tally()

tx_comp_summary %>% 
  arrange(desc(n)) %>% 
  head(5) %>% 
  kable(caption = "Top 5 accidents by insurance agents. Hartford Fire Insurance Company take responsibility for most of the cases.", 
        col.names = c("Insurance Agents", "Total Injuries")) %>% 
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

It will also be useful to see the trends of these injuries over the year. Figure \@ref(fig:accidents-by-insurance-yearly) shows that while the trends of total injuries fluctuate across the year, they had a downward trajectory in general. Hartford Fire Insurance Company, in particular, shows a constant and significant reduction in total ride related injuries across the year. In contrast, Everest Indemnity Insurance Company underwent a reverse trend where its number of ride related injuries rose every year.

It is important to note that having a high number of injuries is not necessarily a reflection of an insurance company being negligence. It may be the case that the parks overseen by the insurance company attracts much more guests compared to other parks. However, given the government is not responsible in overseeing the condition of the rides, it is important to see how the number of injuries distributed to each insurance agents. Further analysis may be warranted to uncover the drivers behind the variability of the number of injuries across insurance agents, as well as its trends across the year. For instance, it may be beneficial to investigate why the rides related injuries constantly decreases every year for Hartford Fire Insurance Company. Insights gained from this investigation have the potential to help the industry as well as the general public as it may minimize rides related accidents. Unfortunately, this is out of scope for this paper due to limitation of data availability.

```{r accidents-by-insurance-yearly, fig.width=9, fig.cap= "A grouped line chart to show yearly trend of number of rides related injuries in Texas. The main group is insurance agent. The x axis is year and the y axis is total number of injury. A reduction of total number of cases related to Hartford Fire Insurance Company can be observed. "}
tx_comp_summary <- tx_comp %>% group_by(agent, injury_year) %>%
  filter(agent != "NA") %>% 
  tally()

accidents_insurance_fig <- tx_comp_summary %>% 
  ggplot(aes(x = injury_year,
             y = n,
             colour = agent)) +
  geom_line() +
  geom_point() +
  labs(colour = "Insurance Agents") +
  theme_minimal() +
  xlab("Year") +
  ylab("Total Injury")

ggplotly(accidents_insurance_fig)
```

## what are the most frequent words in injury description? And what are the characteristics of body part injured related to age, gender and year?

```{r sq1-wordcloud, fig.cap = "Injury description --- word cloud. Words that are biggest are neck, upper limbs and lower limbs."}
data(stop_words)
pain <- tribble( # create a new list for removing common words in the injury description
  ~word, ~lexicon,
  "pain", "SMART",
  "injury", "SMART",
  "injuries", "SMART")

safer_parks %>% 
  select(injury_desc) %>% 
  unnest_tokens(word, injury_desc) %>% 
  anti_join(stop_words) %>% 
  anti_join(pain) %>% 
  count(word) %>% 
  mutate(count = n) %>%
  select(-n) %>%
  wordcloud2(word, size = 1)
```

First, We create a new list containing common workds, such as *injury*, *injuries* and *pain*. Second, we remove unimportant words from injury description. Finally, the word cloud is created. We can see that within the word cloud (Fig \@ref(fig:sq1-wordcloud)) bigger the word more often it appears. Head may be the most frequent word; so, we may assume that most people get hurt on their heads.

In summary, in high proportion of injury cases, the injured get hurt of their upper half of the body. Thus, visitors should protect their head, neck and shoulder. Those body parts are vulnerable and important and they are always injured in amusement park injury cases.

We then dig into the details of body part injured using only the accidents in Texas. We group the body parts into head, neck, upper limbs, torso and lower limbs. And then analyse its relationships with age, gender and year.

```{r bag, fig.cap="A grouped violin plot for age. The main group is body part injured and the subgroup is gender. The x axis is body part injured and the y axis is age. People who get head injuries are more likely to be young people. A great proportion of people who get lower limbs injuries are boys."}
word_list <- list("mouth", "knee", "shoulder", "foot", "back", "neck", "leg", "tail", "ankle", "tooth", "forearm", "lip", "finger", "seizure", "elbow", "face", "nose", "chin", "eye", "eyebrow", "forehead", "wrist", "ear", "genital", "knot", "hand", "abdomen", "arm", "clavical", "cheek", "chest", "glute", "rib", "toe", "jaw", "thumb", "teeth", "stomach", "groin", "hip", "clavicle", "skin", "eyelid", "collar", "vagina", "spleen", "butt", "body", "midsection", "torso")

temp <- tx_injuries

my_fun <- function(word){
  temp[[word]] <<- grepl(word, tolower(temp$body_part), fixed = TRUE)
  return()
}

temp2 <- map(word_list, my_fun)

temp <- temp %>%
  gather(key = "body_part_clean", value = "logic", mouth:torso) %>%
  filter(logic) %>%
  select(-logic)

my_replace <- function(temp, a, b){
  for (i in a){
    temp <- mutate(temp, body_part_clean = ifelse(body_part_clean == i, b, body_part_clean))
  }
  return(temp)
}

temp <- temp %>%
  my_replace(c("mouth", "tooth", "lip", "seizure", "face", "nose", "chin", "eye", "eyebrow", "forehead", "ear", "cheek", "jaw", "teeth", "eyelid"), "head") %>%
  my_replace(c("neck"), "neck") %>%
  my_replace(c("back", "tail", "genital", "knot", "abdomen", "clavical", "chest", "glute", "stomach", "groin", "hip", "clavicle", "collar", "vagina", "spleen", "butt", "body", "midsection"), "torso") %>%
  my_replace(c("shoulder", "forearm", "finger", "elbow", "wrist", "hand", "arm", "thumb"), "upper limbs") %>%
  my_replace(c("knee", "foot", "leg", "ankle", "rib", "toe"), "lower limbs")

temp <- mutate(temp, age = as.numeric(age))
temp <- filter(temp, age > 0) %>%
filter(body_part_clean != "skin") %>%
mutate(body_part = body_part_clean) %>%
filter(gender %in% c("F", "M"))

p <- temp %>%
  ggplot() +
  geom_violin(aes(body_part, age, col = gender), draw_quantiles = c(0.25,0.5,0.75) ) +
  xlab("Body part injured") +
  ylab("Age")

p
```

From the Figure \@ref(fig:bag), we find that people who get head injuries are most likely to be people with age below 20. Besides, the number of boys who get lower limbs injuries is significantly larger than the number of girls get lower limbs injuries.

The first finding suggests that either devices that has higher chance to hurt people's head are more popular among young people, or young people are at a higher risk of head injuries in amusement park. Both of the hypotheses need to be examined by stakeholders carefully and then take corresponding actions to mitigate them.

The second finding suggests that either the difference of choice on devices between boys and girls leads to this findings, or the reckless behaviour of boys in amusement park puts them at risk of lower limbs injuries. 


```{r yb, fig.cap="Grouped line plot for number of injury across 4 years faceted by different body part injuries. The main group is gender. The high number of lower limbs injuries in 2017 and upper limbs injuries in 2015 are mainly related to Skygroup investment LLC and Six Flags. In addition, there is a clear reduction on torso injuries.", fig.width=9}
temp %>%
  group_by(injury_year, gender, body_part) %>%
  summarise(count = n()) %>%
  ggplot() +
  geom_point(aes(injury_year, count, col = gender)) +
  geom_line(aes(injury_year, count, col = gender)) +
  xlab('Year') +
  ylab('Number of injury') +
  facet_wrap(~body_part) +
  theme_minimal()-> p

ggplotly(p)
```

In Fig. \@ref(fig:yb) we will not compare the absolute values between gender given we don't have the underlying probability of a visitor being a female, but we can assume the total number of visitors in each year will be similar. Thus, we will focus on the trend over years.

We can observe that the cases in upper limbs injuries in 2015 has a significantly high values in both male and female. This one is interesting and if we further investigate it, we will find that in Table \@ref(tab:furtheri), they are mostly caused by an event called "iFly" operated by Skygroup Investments LLC. Even more interestingly, if we dig into the high number of female lower limbs injuries in 2017 in Table \@ref(tab:furtherii), we will see the "Hurricane Harbor" operated by Six Flags which is ranked third in Table \@ref(tab:furtheri). In conclusion, there are potential issues with the devices operated by these two companies. 

Other than that, in Figure \@ref(fig:yb) we can observe a clear declining trend of cases in torso injuries. That is an indication of improvement on protecting people from being serious injured. 

```{r furtheri}
filter(temp, injury_year == 2015, body_part == "upper limbs") %>%
  select(name_of_operation, ride_name) %>%
  arrange(name_of_operation, ride_name) %>%
  group_by(name_of_operation) %>%
  summarise(count = n()) %>%
  arrange(-count, name_of_operation) %>%
  kable(col.names = c("Name of Operation", "count"), caption = "Name of operation related to lower limbs injuries in 2015 ranked by number of injuries. Skygroup and Six Flags occur most frequently.")%>% 
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

```{r furtherii}
filter(temp, injury_year == 2017, body_part == "lower limbs", gender == "F") %>%
  select(name_of_operation, ride_name) %>%
  arrange(name_of_operation, ride_name) %>%
  group_by(name_of_operation) %>%
  summarise(count = n()) %>%
  arrange(-count, name_of_operation) %>%
  kable(col.names = c("Name of Operation", "count"), caption = "Name of operation related to female upper limbs injuries in 2015 ranked by number of injuries. The top one is Six Flags.") %>% 
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```



## What amusement parks have most injuries in Texas?

Since the injury reporting mechanism varies from state to state, we only analysed the injuries in each park in Texas (assuming that the injury reporting mechanism is the same across parks in Texas). We want to analyse not only the injuries happened every year in each park, but also the total injuries across all the years in each park, so we also kept the injury records with missing injury_year values. 

Figure \@ref(fig:texas-parks-injuries) shows the top 10 amusement parks which have the most injuries in Texas. We can see that the Six Flags Over Texas park has the most amusement park injuries in Texas, especially in year 2013 and 2014. The Sky group Investments LLC DBA iFly Houston Memorial	park had a significant large number of injuries in 2015, while the Typhoon Texas - Austin Park had lots of injuries in 2016.

```{r texas-parks-injuries, fig.align='center', fig.cap="Amusement Park Injuries Ranking in Texas"}
tx_injuries_top <- tx_injuries

tx_injuries_top$name_of_operation <- tolower(tx_injuries_top$name_of_operation)

tx_injuries_tta <- tx_injuries_top %>% 
  filter(str_detect(name_of_operation, "^typhoon")) %>% 
  mutate(name_of_operation = "typhoon taxes - austin")

tx_injuries_other <- tx_injuries_top %>% 
  filter(str_detect(name_of_operation, "^typhoon", negate = TRUE))
  
tx_injuries_top_lower <- bind_rows(tx_injuries_tta, tx_injuries_other)

tx_injuries_top10 <- tx_injuries_top_lower %>%
  group_by(name_of_operation) %>% 
  tally() %>% 
  arrange(desc(n)) %>% 
  head(10)

injury_top_parks_tx <- as.list(unique(tx_injuries_top10$name_of_operation))

tx_injuries_top_lower %>% 
  filter(name_of_operation %in% c(injury_top_parks_tx)) %>% 
  mutate(injury_year = as.factor(injury_year)) %>% 
  group_by(name_of_operation, injury_year) %>% 
  tally() %>% 
  ggplot(aes(x = factor(name_of_operation, level = list.reverse(injury_top_parks_tx)), 
             y = n,
             fill = injury_year)) + 
  geom_col() + 
  coord_flip() + 
  xlab("Park Name") + 
  ylab("Injuries") + 
  labs(fill = "Year") + 
  ggtitle("Amusement Parks with Most Injuries in Texas")
```

## What manufacturer's product caused the most amusement park injuries?
In this part, we will find out the manufacturers whose products caused most amusement injuries over the years. This could remind amusement parks who have devices from these manufacturers to maintain their devices carefully. Figure \@ref(fig:manufacturer-plot) shows the top 10 manufacturers whose products caused most amusement injuries over the years and the percentage of total injuries recorded in the safer_park data set.

There are 254 manufacturers' records in this data set, and the total injuries of them is 8793, while the total injuries of the top 10 manufacturers is 2841. The top 10 manufacturers accounted for 32.3% of all amusement park injuries. It's noteworthy that in-house manufactured devices accounts for more than 10% of total injuries.

```{r manufacturer}
manufacturers <- safer_parks %>% 
  group_by(manufacturer) %>% 
  summarise(total_injuries = sum(num_injured)) %>% 
  arrange(desc(total_injuries)) %>% 
  head(10) 

manufacturers %>% 
  summarise(n = sum(total_injuries)) %>% 
  pull() -> top_manu_injuries

injuries_all_manu <- sum(safer_parks$num_injured, na.rm = TRUE)

count_manufacturer <- length(unique(safer_parks$manufacturer))

manufacturers <- manufacturers %>% 
  mutate(percentage = total_injuries / injuries_all_manu)
```

```{r manufacturer-plot, fig.align='center', fig.cap="Top 10 Manufacturers with Most Injuries"}
manufacturers %>% 
  ggplot(aes(x = reorder(manufacturer, total_injuries))) + 
  geom_col(aes( y = total_injuries, fill = manufacturer)) + 
  geom_text(aes( y = percentage * 10000, label = round(percentage * 100, 2)), vjust = -0.2, size = 3) + 
  scale_y_continuous(name = "Injuries") + 
  theme(legend.position = "none") + 
  ggtitle("Manufacturers Caused Most Injuries") + 
  xlab("Manufacturer") + 
  coord_flip()
```

# Conclusions

In this report, we analysed the amusement park injuries data of the U.S. Since there's no data related to the total number of visitors, it's hard to say whether the parks with less injuries are more safer than others. Keeping this in mind, we obtain several interesting major findings.

1. About half of the injured visitors are younger than 35 years old, and the age group with the most injuries is children between 10 and 15 years old. Injuries of girls in this age group is slightly more than that of boys.

2. Slide and coasters caused more injuries than other kind of rides.

3. In summer, there are more visitors injured in amusement parks, while in winter the number of injuries is much smaller. This may because there are more visitors in summer.

4. Of all the injuries, the most are related to the devices insured by the Hartford Fire Insurance Company. But having a high number of injuries is not necessarily a reflection of an insurance company being negligence. It may be the case that the parks overseen by the insurance company attracts much more guests compared to other parks. 

5. In high proportion of injury cases, the injured get hurt of their upper limbs, lower limbs and neck. Girls are more likely to have lower limbs injuries.

6. iFly operated by Skygroup investment LLC and Hurricane Harbor operated Six Flags take responsibility to the unusual high figures of limbs injuries in 2015 and 2017. There are potential safety issues with their devices.

7. In Texas, the Six Flags Over Texas park has the most amusement park injuries, especially in year 2013 and 2014. The Skygroup Investments LLC DBA iFly Houston Memorial park had a significant large number of injuries in 2015, while the Typhoon Texas Austin Park had lots of injuries in 2016.

8. The in-house manufactured amusement park devices accounts for more than 10% of total injuries. This is a security hazard that can't be ignored. The top 10 manufacturers who caused most injuries accounted for 32.3% of all injuries, while there are 254 manufacturersâ€™ records in this data set.


# Acknowledgments
The following packages are used to produce this report:
visdat [@visdat], dplyr [@dplyr], readr[@readr], tidyverse [@tidyverse], lubridate [@lubridate], knitr [@knitr], kableExtra [@kableExtra], tidytext [@tidytext], wordcloud2 [@wordcloud2], janitor [@janitor], here [@here], plotly [@plotly], rlist[@rlist]


# References


