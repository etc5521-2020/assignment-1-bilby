---
title: "ETC5521 Assignment 1"
subtitle: "Amusement Park injuries"
team: "bilby"
author:
  - "Yuheng Cui"
  - "Jimmy Effendy"
date: "`r Sys.Date()`"
output: 
  bookdown::html_document2
bibliography: reference.bib
biblio-style: authoryear-comp
---

[This assignment is for ETC5521 Assignment 1 by Team `r rmarkdown::metadata$team` comprising of `r knitr::combine_words(rmarkdown::metadata$author)`.]{style="color:#006DAE;"}

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, fig.align = "center")
library(dplyr)
library(visdat)
library(readr)
library(tidyverse)
library(lubridate)
library(knitr)
library(kableExtra)
library(tidytext)
library(wordcloud)
library(here)
library(janitor)
library(plotly)
```

```{r rawData, include = FALSE}
tx_injuries <- read_csv("https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2019/2019-09-10/tx_injuries.csv")


safer_parks <- read_csv("https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2019/2019-09-10/saferparks.csv")

tx_policies <- read.csv(here::here("data/tx_policies.csv"))
```

# Introduction and Motivation

Families and friends tend to spend their holidays and weekends in amusement parks. The popularity of amusement park has been growing in popularity in recent years, with worldwide attendance at the top 10 amusement park groups reached half a billion mark for the first time last year [@schneider_2019], with 4% year-on-year growth [@tea2019].

With this ever increasing popularity, it is therefore not unreasonable to consider that the safety of amusement rides is a subject to substantial public interests [@woodcock2014amusement]. It was estimated that the annual number of ride-related injuries in North America was 1,289 in 2018; which is 26% higher compared to 2017 [@iaapa2018]. International Association of Amusement Parks and Attractions further stated that approximately 11% of those injuries are "serious", meaning they result in urgent admission and hospitalization for more than 24 hours for non-medical observation reasons, or causes fatality.

While accidents occurred in amusement parks are arguably not frequent, they generate prominent effects when they happen. International Association of Amusement Parks and Attractions [-@iaapa2017] reported that following a ride malfunction in Australia killing four people, the park and also other venues in Australia suffer considerable declines in attendance. This shows that public confidence, safety, and commercial feasibility are strongly linked [@woodcock2014amusement].

There are 25 amusement parks in Texas already [@wiki]. Indeed, amusement parks are good place for kids and young people, but there are also much news reporting accidents in amusement park, and some news are horrible. These news remind people to take care of themselves when playing. More importantly, amusement parks should reduce the probability of mechanical failure and operation errors.

Thorough evaluations to injury records related to amusement parks are aligned with public interests and are integral to encourage constant improvement. This paper intends to find factors that have major influence to amusement ride accidents. Uncovering this insight may encourage amusement park owners to utilize their resources more wisely in favor of those groups or equipment that are at the most risk. In addition, this report may also facilitate regulatory bodies in developing safety standards and regulations.

This study intends to find out the patterns within injuried groups. The patterns refer to the high-risk groups, high-risk equipment and seasonal trend of injuries. We believe amusement park must make the effort to reduce the incidents; the effort refers to maintaining equipment, training staff and monitoring visitors. At same time, visitors should also follow the parks regulations and equipment instructions. After all, visitors should be responsible for their own safeties in the first place. Reduce the injuries occur in amusement parks and increase the well beings of society. 

Firstly, description of data used in the report and how it is prepared for analysis will be discussed. Then, analysis and findings acquired from the data set will be presented and discussed.

# Data Description

The datasets are downloaded from [here](https://github.com/rfordatascience/tidytuesday/tree/master/data/2019/2019-09-10) from GitHub. There are two datasets provided in the repository; one originated from [data.world](https://data.world/amillerbernd/texas-amusement-park-accidents) and another from [Saferparks database](https://ridesdatabase.org/saferparks/data/). An additional data from Texas Department of Insurance (TDI) about current available insurance policies is used for this report [@tdi_pol].

The data.world data set originated from TDI [@dataworld]. It is a record of any injuries caused by an amusement ride from February the 1st 2013 to February the 1st 2017 occurring in the State of Texas [@dataworld]. An amusement ride is "any mechanical, gravity, or water device or devices that carry or convey passengers along, around, or over a fixed or restricted route or course or within a defined area for the purpose of giving its passengers amusement, pleasure, or excitement" [@tdi]. According to TDI [-@tdi], a quarterly injury report needed to be submitted by amusement ride owners and operators. TDI further stated that this record relates to any injuries that require medical treatment or result in death. 

This data set has `r nrow(tx_injuries)` number of observations and `r ncol(tx_injuries)` number of variables. Fig \@ref(fig:quality-of-tx) shows the data set has too many missing values in **other** variable and many missing values in **serial_no** variable. Good news is that these two variables has little effects on our analysis, thus, we can remove these two variables. **Age** should be converted to numeric variable and **injury_date** should be date variable.

```{r quality-of-tx, fig.cap = "Texas amusement parks dataset"}
vis_dat(tx_injuries)
```

The accidents records in the Saferparks data set, on the other hand, originated from the U.S. State and Federal safety agencies regulating amusement rides [@saferpark_web]. Saferparks achieved this by submitting public records requests to those agencies (both federal and states agencies). In some cases, additional requests were submitted to specific agencies to achieve particular goals [@saferpark_web]. As a result, Saferparks needs to harmonize these data sets into their database.  

It has `r nrow(safer_parks)` observations and `r ncol(safer_parks)` variables. Fig \@ref(fig:quality-of-safer) shows 4 variables have too many missing values to be analysed, therefore, we ought to ignore them. **acc_date** should be converted to date variable. Although **manufacturer** has many missing values as well, we decided to keep it because it may be insightful.

```{r quality-of-safer, fig.cap = "Saferparks dataset"}
vis_dat(safer_parks)
```

## Data Limitation

There is limited documentation related to accident reports provided by TDI. It is therefore difficult to determine the limitation related to the data set. In addition to a considerable amount of missing value to some of the variables, data dictionary is not provided by TDI. As a result, it is difficult to be certain about what some of the variables represent. Lastly, there is some inconsistency of format in *injury_date* variable.

According to Saferparks [-@saferpark], reporting criteria and its level of details, types of equipment included, and years covered vary widely by year, industry sector, jurisdictions, and other factors. Saferparks further stated that States that is transparent, vigilantly monitor safety incidents, and implement data management system that is efficient will log higher number of accidents. As a result, this is and indications of being more attentive to safety, not less [@saferpark]. 

While the data set can be used to uncover insights of how patrons are hurt in amusement rides, Saferparks do not recommend the data set to be used for comparison across states, parks, rides or years [@saferpark]. One of the reasons for this is that State laws in relation to amusement ride related injury reporting vary widely. For instance, it is mandatory to report go-kart accidents in Flordia but not in California.

Due to these limitations, the report will not use the Saferparks data set to analyze nation-wide patterns. Hence, this report will largely focus on amusement park accidents that occur in Texas, United States of America.


## Data Cleaning and Transformation

A considerable amount of data wangling needed to be done to the TDI injury data set prior to the analysis. Firstly, there are inconsistencies of format in the date variable where some of the observations were stored in a serial number format that only Excel recognize (e.g. 39448). Dates with this format needed to be converted to "YYYY-MM-DD" format.

Secondly, the following variables were added to the TDI injury data set:

* injury_year: the year when the observed injury occurred
* injury_month: the month when the observed injury occurred
* injury_day: the day when the observed injury occurred
* season: the season (U.S.) when the observed injury occurred

TDI data set about current insurance policies were also needed to be cleaned. Firstly, the janitor package was used to make the column names tidy. Next, the agent variable were needed to be cleaned as there were many observations that were misspelled.

Finally, the TDI injury data set were combined with TDI insurance policies data set.

Much of the data wrangling and transformation process were done by utilizing the dplyr and lubridate packages.

```{r clean}
#cleaning the injury_date variable
#there were some inconsistency in the format
tx_injuries <- tx_injuries %>% 
  mutate(injury_date = case_when(
    nchar(injury_date) == 5 ~ as.Date(as.numeric(injury_date), origin = "1899-12-30"),
    TRUE ~ mdy(injury_date)
  ))

#adding year, month, day variables to tx_injuries
tx_injuries <- tx_injuries %>% 
  mutate(injury_year = year(injury_date),
         injury_month = month(injury_date, label = TRUE, abbr = TRUE),
         injury_day = day(injury_date)) %>% 
  mutate(season = case_when(
    injury_month == "Jan" ~ "Winter",
    injury_month == "Feb" ~ "Winter",
    injury_month == "Mar" ~ "Spring",
    injury_month == "Apr" ~ "Spring",
    injury_month == "May" ~ "Spring",
    injury_month == "Jun" ~ "Summer",
    injury_month == "Jul" ~ "Summer",
    injury_month == "Aug" ~ "Summer",
    injury_month == "Sep" ~ "Autumn",
    injury_month == "Oct" ~ "Autumn",
    injury_month == "Nov" ~ "Autumn",
    injury_month == "Dec" ~ "Winter",
    TRUE ~ "NA"
  ))

tx_policies <- tx_policies %>%
  janitor::clean_names() %>% 
  mutate(agent = case_when(
    agent == "Ace American Ins Co (Chubb)" ~ "ACE American Insurance Company",
    agent == "Ace American Insurance Company" ~ "ACE American Insurance Company",
    agent == "Hartford Fire Insurance Compan" ~ "Hartford Fire Insurance Company",
    agent == "T.H.E Insurance company" ~ "T.H.E. Insurance Company",
    agent == "Certain Underwriters at Lloyds" ~ "Lloyds",
    TRUE ~ as.character(agent)
  ))
```



```{r tx-complete}
#joining tx_injuries tibble with tx_policies tibble
tx_comp <- tx_injuries %>% 
  left_join(tx_policies,
            by = c("injury_report_rec" = "i_record")) %>% 
  select(-name_of_operation.y) %>% 
  rename(name_of_operation = name_of_operation.x)
```

# Analysis and findings

## Primary question: what are the high-risk groups?

The primary question in this report is to find out the high-risk group. Consequently, help parks to target these groups and also remind the groups taking care of their own. We mainly analyse the age and gender for the primary quesiton. The Saferparks dataset cannot be used here, because the dataset does not have detail individual records; therefore, we do not know the ages of each injuried. 

First, we need to clean the data. The missing values in age and gender is removed and the variable type is converted from character to numeric. Second, we unify the records in gender because some observations record gender male as 'M' while others record as 'm'. Third, calculate the percentage of each age group.

```{r tx-pm1, fig.cap = "Bar plot for age"}
tx_gender_age <- tx_injuries %>%
  # remove missing values in gender
  filter(!is.na(gender)) %>% 
  mutate(gender = recode(gender,
                         "m" = "M",
                         "f" = "F",
                         "n/a" = "unknown",
                         "N/A" = "unknown")) %>% # unify gender record
  mutate(age = as.numeric(age)) %>% 
    # remove missing values in age
  filter(!is.na(age))
   

tx_ob <- nrow(tx_gender_age)

p1 <- tx_gender_age%>% 
  group_by(gender, age) %>% 
  count(gender,age) %>% 
  ungroup() %>% 
  mutate(percent = round(n*100/tx_ob, 2)) %>% 
  select(-n) %>% 
  ggplot(aes(x = age, y = percent, fill = gender)) +
  geom_bar(stat="identity")+
  # geom_text(aes(y=label_ypos, label=percent), vjust=1.6, 
  #           color="white", size=3.5)+
  # scale_fill_brewer(palette="Paired")+
  theme_minimal()

ggplotly()
```

```{r tx-pm1-tab}
tx_gender_age %>% 
  group_by(age) %>% 
  count() %>% 
  mutate(percent = n*100/tx_ob) %>% 
  arrange(-percent) %>% 
  select(-n) %>% 
  head(10) %>% 
  kable(caption = "Top 10 risky age group in amusement parks in Texas") %>% 
  kable_styling(bootstrap_options = c("striped", "hover"))
```

```{r tx-pm1-gender}
tx_gender_age%>% 
  group_by(gender, age) %>% 
  count(gender,age) %>% 
  ungroup() %>% 
  mutate(percent = round(n*100/tx_ob, 2)) %>% 
  select(-n) %>% 
  arrange(-percent) %>% 
  head(10) %>% 
  kable(caption = "Top 10 risky group by gender in amusement parks in Texas") %>% 
  kable_styling(bootstrap_options = c("striped", "hover"))
```



```{r tx-pm1-pct, include = FALSE}
tx_kid <- tx_gender_age %>% 
  group_by(age) %>% 
  count() %>% 
  mutate(percent = n*100/tx_ob) %>% 
  arrange(-percent) %>% 
  ungroup() %>% 
  filter(age < 18 & age > 0) %>% 
  pull(percent) %>% 
  sum()

tx_kid_fe <- tx_gender_age%>% 
  group_by(gender, age) %>% 
  count(gender,age) %>% 
  ungroup() %>% 
  mutate(percent = round(n*100/tx_ob, 2)) %>% 
  filter(gender == "F" & age < 18 & age >0) %>% 
  pull(percent) %>% 
  sum()

tx_kid_m <- tx_kid - tx_kid_fe
```

Table \@ref(tab:tx-pm1-tab) shows the ranking of injuried ages. Injuried babies occupies nearly 10% of the dataset. In the dataset `r round(tx_kid, 2)` percent injuried are under 18, except babies. We distinguish babies from other age groups because babies are carried by their parents and babies are not able to move to any places by their own. 

If we take gender into account, we can see gender distributions by age. Table \@ref(tab:tx-pm1-gender) shows the top-10 rankings by gender and age. In top-10 list, it seems that more girls get injuried than boys in amusement parks in Texas. However, if we look at the whole dataset, age 18, `r round(tx_kid_fe, 2)` percent are girls while `r round(tx_kid_m, 2)` are boys.

In summary, the age range of the injured is broad (from 0 to 71). But the most injured are young people, especially for children (under 18). And the fact that almost 10 percent of the injured are babies indicates that parents must take care of their babies in amusement parks. They should put their babies in first priority.  


## Secondary question 1: what is the most dangerous equipment in parks and what is the most body parts injuried?

First secondary question is "what is the most dangerous equipment in parks". We count the total number of injuries by device type. Table \@ref(tab:safer-equip) shows top-10 rankings of high-risk equipment. It is not surprising that roller coaster is the equipment that causes the most injuries. @gutierrez reported that seven cases are related to roller coaster among eight high-profile U.S. amusement park deaths before 2016. 

```{r safer-equip} 
safer_parks %>% 
  group_by(device_type) %>% 
  summarise(tot_num_injuries = sum(num_injured)) %>% 
  arrange(-tot_num_injuries) %>% 
  head(10) %>% 
  kable(caption = "Top 10 risky device type") %>% 
  kable_styling(bootstrap_options = c("striped", "hover"))
```

```{r sq1-wordcloud, fig.cap = "Injury description --- word cloud", out.height= '100%', out.width= '100%'}
data(stop_words)
pain <- tribble( # create a new list for removing common words in the injury description
  ~word, ~lexicon,
  "pain", "SMART",
  "injury", "SMART",
  "injuries", "SMART")
safer_parks %>% 
  select(injury_desc) %>% 
  unnest_tokens(word, injury_desc) %>% 
  anti_join(stop_words) %>% 
  anti_join(pain) %>% 
  count(word) %>% 
  with(wordcloud(word, n ,max.words = 80))

```

First, We create a new list containing common workds, such as *injury*, *injuries* and *pain*. Second, we remove unimportant words from injury description. Finally, the word cloud is created. We can see that within the word cloud (Fig \@ref(fig:sq1-wordcloud)) bigger the word more often it appears. Head may be the most frequent word; so, we may assume that most people get hurt on their heads.

In summary, in high proportion of injury cases, the injured get hurt of their upper half of the body.  amusement parks should pay extra attention on roller coaster because unlike other subjects, roller coaster's failure can cause severe consequence --- no one can escape once a roller coaster is launched. First, they should regularly maintain the roller coaster, in order to reduce mechanical failure. Second, train the staff and ask them to check to-do list every time launch the equipments. Third, ask visitors to follow the safety guide. Furthermore, visitors should also protect their head, neck and shoulder. Those body parts are vulnerable and important and they are always injuried in amusement park injury cases.

## Injuries and Seasonal Trends

**Does amusement ride injuries have seasonal characteristics?**

This section will examine whether seasonal trends affected number of amusement ride injuries across the year. Table \@ref(tab:seasonal-trends-table) shows that rides related injuries have seasonal trends and they are consistent across the year. The number of injuries occurred in autumn and winter seasons were relatively low. The number of injuries started to rise in spring, and reached its peak in summer.

```{r seasonal-trends-table}
tx_season_table <- tx_injuries %>% 
  filter(season != "NA") %>% 
  group_by(injury_year, season) %>% 
  tally() %>% 
  pivot_wider(names_from = injury_year,
              values_from =n)

tx_season_table %>% 
  kable(caption = "Amusement Rides Related Injuries across Years and Seasons", 
        col.names = c("Season", "2013", "2014", "2015", "2016", "2017")) %>% 
  kable_styling(bootstrap_options = c("striped", "hover"))
```

Figure \@ref(fig:seasonal-trends-plot) shows how the number of injuries occurred in amusement rides distributed across months and years. It is reflected in the graph that the highest number of injuries that occurred in a single month appeared in June 2015 with 41 injuries. Another interesting feature that appears in the graph is that the numbers of rides related injuries in 2014 and 2017 are relatively low compared to other years.

It may be beneficial for ride owners to focus their resources in spring and summer when number of injuries are at its height. More regular and rigorous inspections to the ride equipment can be performed during these periods. Furthermore, ride owners may also provide staff with additional training in the periods leading up to summer. It may also be advantageous to perform further study to uncover the true drivers behind 2014's and 2017's low number of injuries.


```{r seasonal-trends-plot, fig.cap="Ride Related Injuries Seasonal Trends"}
tx_month <- tx_injuries %>% 
  filter(injury_year != "NA") %>% 
  filter(injury_month != "NA") %>% 
  group_by(injury_year, injury_month) %>% 
  tally()

tx_month$injury_year <- as.factor(tx_month$injury_year)
tx_month$injury_month <- as.factor(tx_month$injury_month)

tx_season_plot <- tx_month %>% 
  ggplot(aes(x = injury_month,
             y = n,
             group = injury_year)) +
  geom_line(aes(color = injury_year)) +
  geom_point(aes(color = injury_year)) +
  labs(colour = "Year") +
  theme_minimal() +
  xlab("Month") +
  ylab("Total Injury")
  

ggplotly(tx_season_plot)
```

## Injuries and Insurance Company

**Are numbers of amusement rides injuries affected by insurance company?**

According to TDI [-@tdi_req], every amusement ride in Texas is required to display a compliance sticker. To get these stickers, rides must be insured and inspected [@tdi_req]. TDI, however, are not involved with rides inspections. Instead, it is the ride owner's insurance company that are responsible to perform these inspections. This section will explore whether number of injuries vary across insurance agents responsible in inspecting the quality of rides. A summary table of accidents occurred by insurance agents were constructed by using the combined table of TDI injuries and insurance policies data set. Table \@ref(tab:accidents-by-insurance) shows that the majority of rides related injuries occurred in amusement parks that were overseen by Hartford Fire Insurance Company. It is still larger compared to the number of injuries from the rest of the table combined.

```{r accidents-by-insurance}
tx_comp_summary <- tx_comp %>% group_by(agent) %>%
  filter(agent != "NA") %>% 
  tally()

tx_comp_summary %>% 
  arrange(desc(n)) %>% 
  head(5) %>% 
  kable(caption = "Top 5 Accidents by Insurance Agents", 
        col.names = c("Insurance Agents", "Total Injuries")) %>% 
  kable_styling(bootstrap_options = c("striped", "hover"))
```

It will also be useful to see the trends of these injuries over the year. Figure \@ref(fig:accidents-by-insurance-yearly) shows that while the trends of total injuries fluctuate across the year, they had a downward trajectory in general. Hartford Fire Insurance Company, in particular, shows a constant and significant reduction in total ride related injuries across the year. In contrast, Everest Indemnity Insurance Company underwent a reverse trend where its number of ride related injuries rose every year.

It is important to note that having a high number of injuries is not necessarily a reflection of an insurance company being negligence. It may be the case that the parks overseen by the insurance company attracts much more guests compared to other parks. However, given the government is not responsible in overseeing the condition of the rides, it is important to see how the number of injuries distributed to each insurance agents. Further analysis may be warranted to uncover the drivers behind the variability of the number of injuries across insurance agents, as well as its trends across the year. For instance, it may be beneficial to investigate why the rides related injuries constantly decreases every year for Hartford Fire Insurance Company. Insights gained from this investigation have the potential to help the industry as well as the general public as it may minimize rides related accidents. Unfortunately, this is out of scope for this paper due to limitation of data availability.

```{r accidents-by-insurance-yearly, fig.width=10, fig.cap= "Yearly Trend of Number of Rides Related Injuries in Texas"}
tx_comp_summary <- tx_comp %>% group_by(agent, injury_year) %>%
  filter(agent != "NA") %>% 
  tally()

accidents_insurance_fig <- tx_comp_summary %>% 
  ggplot(aes(x = injury_year,
             y = n,
             colour = agent)) +
  geom_line() +
  geom_point() +
  labs(colour = "Insurance Agents") +
  theme_minimal() +
  xlab("Year") +
  ylab("Total Injury")

ggplotly(accidents_insurance_fig)
```

# Acknowledgments
The following packages are used to produce this report:
visdat [@visdat], dplyr [@dplyr], readr[@readr], tidyverse [@tidyverse], lubridate [@lubridate], knitr [@knitr], kableExtra [@kableExtra], tidytext [@tidytext], wordcloud [@wordcloud], janitor [@janitor], here [@here], plotly [@plotly]


# References


